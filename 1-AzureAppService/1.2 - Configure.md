# [Configure web app settings](https://learn.microsoft.com/en-us/training/modules/configure-web-app-settings/)<!-- omit in toc -->

## Table of contents <!-- omit in toc -->

- [Application settings](#application-settings)
  - [Adding/editing](#addingediting)
  - [Connection strings](#connection-strings)
- [General settings](#general-settings)
- [Path mappings](#path-mappings)
  - [Windows/uncontainerized apps](#windowsuncontainerized-apps)
  - [Linux/containerized apps](#linuxcontainerized-apps)
- [Diagnostic logging](#diagnostic-logging)
  - [Enable logging](#enable-logging)
  - [Stream logs](#stream-logs)
  - [Access log files](#access-log-files)
- [Security certificates](#security-certificates)
  - [Options](#options)
  - [Free managed certificate](#free-managed-certificate)
  - [Purchase app certificate](#purchase-app-certificate)
  - [Upload private certificate](#upload-private-certificate)
  - [Enfore HTTPS](#enfore-https)
- [Manage app features](#manage-app-features)
  - [Code usage](#code-usage)
  - [Feature flag declaration](#feature-flag-declaration)
  - [Feature flag repository](#feature-flag-repository)

## [Application settings](https://learn.microsoft.com/en-us/training/modules/configure-web-app-settings/2-configure-application-settings)

> App settings are passed as **environment variables** to the application code

### Adding/editing

`Configuration > Application settings > New application setting/Edit`

Bulk: `Advanced edit`

```json
[
  {
    "name": "<key-1>",
    "value": "<value-1>",
    "slotSetting": false // deployment slot
  },
  {
    "name": "<key-2>",
    "value": "<value-2>",
    "slotSetting": false // deployment slot
  }
  // ...
]
```

### Connection strings

```json
[
  {
    "name": "name-1",
    "value": "conn-string-1",
    "type": "SQLServer",
    "slotSetting": false // deployment slot
  },
  {
    "name": "name-2",
    "value": "conn-string-2",
    "type": "PostgreSQL",
    "slotSetting": false // deployment slot
  }
  // ...
]
```

## [General settings](https://learn.microsoft.com/en-us/training/modules/configure-web-app-settings/3-configure-general-settings)

`Configuration > General settings`

- **Stack settings**
  - Languague
  - SDK version
  - Startup command (Linux)
- **Platform settings**
  - 32/64-bit
  - Websocket protocol
  - Always on
  - Managed pipeline version
  - HTTP version
  - ARR (Application Request Routing) affinity: client is routed to same instance during session
- **Remote debugging**
- **Incoming client certificates**

## [Path mappings](https://learn.microsoft.com/en-us/training/modules/configure-web-app-settings/4-configure-path-mappings)

`Configuration > Path mappings`

### Windows/uncontainerized apps

- Configure **custom script processors**/handlers:
  - File extension
  - Script processor path
  - Arguments
- Configure **virtual apps & directories**:
  - Path relative to `D:\home`

_default root `/` mapped to `D:\home\site\wwwroot`_

### Linux/containerized apps

`New Azure Storage Mount`

Custom storage config:

- Name
- Configuration options
- Storage accounts
- Storage types (blob/files)
- Storage container
- Share name
- Access key
- Mount path

## [Diagnostic logging](https://learn.microsoft.com/en-us/training/modules/configure-web-app-settings/5-enable-diagnostic-logging)

| Type                   | Supported platform | Location                                                                   | Description                                                                                                             |
| ---------------------- | ------------------ | -------------------------------------------------------------------------- | ----------------------------------------------------------------------------------------------------------------------- |
| Application logging    | Windows, Linux     | <ul><li>App Service file system </li> <li> Azure Storage blobs </li> </ul> | Log messages generated by application code. Each message has a category (Critical, Error, Warning, Info, Debug, Trace). |
| Web server logging     | Windows            | <ul><li>App Service file system </li> <li> Azure Storage blobs </li> </ul> | Raw HTTP request data (W3C extended log file format).                                                                   |
| Detailed error logging | Windows            | App Service file system                                                    | `.html` error pages that would be sent to the client (HTTP status >= 400).                                              |
| Failed request tracing | Windows            | App Service file system                                                    | Tracing information on failed request with trace of IIS components. One folder per request with XML and XSL files.      |
| Deployment logging     | Windows, Linux     | App Service file system                                                    | Deployment information.                                                                                                 |

### Enable logging

- **Application logging**: `App Service logs > Application logging (Filesystem)` or `Application logging (Blob)`
- **Web server logging**: `App Service logs > Web server logging`

### Stream logs

> Any information written to `.txt`, `.log`, `.htm` files in `/LogFiles` (`D:\home\logfiles`) is streamed.

- **Azure portal**: `Log stream`
- **Azure CLI**
  `az webapp log tail --name appname --resource-group myResourceGroup`

### Access log files

- **Azure Storage blob**: use client tool
- **App Service file system**
  - Windows: `https://<app-name>.scm.azurewebsites.net/api/dump`
  - Linux: `https://<app-name>.scm.azurewebsites.net/api/logs/docker/zip`

## Security certificates

> Certificates uploaded into an app are stored in a deployment unit bound to the app service plan's **resource group and region combination** (= webspace). Certificates are accessible to other apps in the same webspace.

### Options

- Free App Service managed certificate
- Purchase App Service certificate
- Import from key vault
- Upload private certificate
- Upload public certificate

### Free managed certificate

- Requires **Basic**, **Standard**, **Premium** or **Isolated** tier
- **TLS/SSL server** certificate
- Automatic **renewal** (6 months)
- Limitations:
  - No support for **wildcard certificates**
  - No support for usage as **client certificate** by **certificate thumbprint**
  - Not exportable
  - Not supported on **App Service Environment** (ASE)
  - Not supported with **root domains** integrated with **Traffic Manager**
  - If certificate is for **CNAME-mapped domain**, CNAME must be mapped directly to `<app-name>.azurewebsites.net`

### Purchase app certificate

- Purchase process from **GoDaddy**
- **Domain verification**
- Maintenance in **Azure Key Vault**
- Certificate **renewal**
- **Automatic synchronization** with imported copies in App Service apps

### Upload private certificate

- Requirements:
  - Exported as password-protected **PFX file**, encrypted using **triple DES**
  - Contains **private key** (>= 2048 bits)
  - Contains all **intermediate certificates** in certificate chain
  - When securing custom domain in TLS binding:
    - **Extended Key Usage** for server authentication
    - Signed by **trusted certificate authority**
- Export OpenSSL certificate to PFX
  `openssl pkcs12 -export -out myserver.pfx -inkey <private-key-file> -in <merged-certificate-file>`

### Enfore HTTPS

`TLS/SSL settings > HTTPS Only` => On

## Manage app features

> **Feature flags** (or feature toggles, switches) are external variables used to **dynamically disable/enable parts of application code**.

- **Feature flag**: boolean variable
- **Feature manager**: package that handles feature flag lifecycles
- **Filter**: rule for evaluating flag state

### Code usage

```Csharp
bool featureFlag = isBetaUser();

if (featureFlag) {
    // beta feature
} else {
    // nothing or alternative feature
}
```

### Feature flag declaration

Feature flags have 2 parts:

- Name
- List of filters to determine if feature is enabled

```json
// appsettings.json
"FeatureManagement": {
    "FeatureA": true, // Feature flag set to on
    "FeatureB": false, // Feature flag set to off
    "FeatureC": {
        "EnabledFor": [
            {
                "Name": "Percentage",
                "Parameters": {
                    "Value": 50
                }
            }
        ]
    }
}
```

### Feature flag repository

> Feature flags should be **stored externally** so they can be modified without redeploying.

**Azure App Configuration** can be used to define and manage feature flags. App Configuration **libraries** are available to access flags in application code.
